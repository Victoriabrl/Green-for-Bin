{% extends "base.html" %}

{% block title %}Visualisations{% endblock %}

{% block content %}
    <h1 class="text-center">{{ _('Vous pouvez visualiser les données de vos poubelles ici.') }}</h1>

    <h2 class="text-center">{{ _('Statistiques') }}</h2>
    <div class="table-responsive d-flex justify-content-center">
        <table id="stats-table" class="table table-striped table-hover align-middle custom-table-center" style="max-width: 600px;">
            <thead>
                <tr>
                    <th>{{ _('Type') }}</th>
                    <th>{{ _('Valeur') }}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ _('Nombre total d\'annotations') }}</td>
                    <td>{{ total_annotations }}</td>
                </tr>
                <tr>
                    <td>{{ _('Nombre d\'annotations poubelles pleines') }}</td>
                    <td>{{ full_annotations }}</td>
                </tr>
                <tr>
                    <td>{{ _('Pourcentage pleines') }}</td>
                    <td>
                        {% if total_annotations > 0 %}
                            {{ ((full_annotations / total_annotations) * 100) | round(1) }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>{{ _('Nombre d\'annotations poubelles vides') }}</td>
                    <td>{{ empty_annotations }}</td>
                </tr>
                <tr>
                    <td>{{ _('Pourcentage vides') }}</td>
                    <td>
                        {% if total_annotations > 0 %}
                            {{ ((empty_annotations / total_annotations) * 100) | round(1) }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>{{ _('Nombre d\'annotations non labelisées') }}</td>
                    <td>{{ non_labelled_annotations }}</td>
                </tr>
                
                
            </tbody>
        </table>
    </div>

    <h2 class="mt-4 text-center">{{ _('Visualisations') }}</h2>
    <div class="row mb-4 justify-content-center">
        <div class="col-md-6 d-flex justify-content-center">
            <canvas id="progressChart" style="max-width: 100%; height: 260px;"></canvas>
        </div>
        <div class="col-md-6 d-flex justify-content-center">
            <canvas id="repartition" style="max-width: 100%; height: 260px;"></canvas>
        </div>
    </div>

    <div class="row mb-4 justify-content-center">
        <div class="col-12 text-center">
            <h5>{{ _('Distribution des tailles de fichiers :') }}</h5>
            <canvas id="distribution" style="max-width: 100%; height: 260px;"></canvas>
        </div>
    </div>


    <img src="{{ image_base64 }}" alt="Graphique" class="img-fluid mb-2">
    <img src="{{ img_base64_distribution }}" alt="Graphique de distribution des tailles de fichiers" class="img-fluid mb-2">
    <img src="{{ img_base64_nombre }}" alt="Graphique de nombre d'images" class="img-fluid mb-4">

    <!-- Tableau des moyennes std_h, std_s, std_v -->
    <div class="row mb-4 justify-content-center">
        <div class="col-12 text-center">
            <h5>{{ _('Moyennes des écarts-types HSV (Couleur, Saturation, Luminosité)') }}</h5>
            <table class="table table-bordered table-striped w-auto custom-table-center" style="max-width:400px">
                <thead>
                    <tr>
                        <th>Couleur</th>
                        <th>Saturation</th>
                        <th>Luminosité</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ std_h_mean|default('N/A')|round(2) if std_h_mean is not none else 'N/A' }}</td>
                        <td>{{ std_s_mean|default('N/A')|round(2) if std_s_mean is not none else 'N/A' }}</td>
                        <td>{{ std_v_mean|default('N/A')|round(2) if std_v_mean is not none else 'N/A' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- NOUVEAU : Tableau par arrondissement -->
    <section class="section" id="arrondissements-stats" style="background: #fff;">
        <div class="container">
            <h2 class="section-title text-center">{{ _('Tableau de Bord par Arrondissement') }}</h2>
            <div class="row justify-content-center">
                <div class="col-12">
                    <div class="modern-table">
                        <table id="arr-table" class="table table-hover mb-0 custom-table-center" style="max-width:900px; margin:auto;">
                            <thead>
                                <tr>
                                    <th>{{ _('Arrondissement') }}</th>
                                    <th>{{ _('Poubelles pleines') }}</th>
                                    <th>{{ _('Poubelles vides') }}</th>
                                    <th>{{ _('%% Pleines') }}</th>
                                    <th>{{ _('%% Vides') }}</th>
                                    <th>{{ _('Statut') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in arr_stats %}
                                <tr>
                                    <td>{{ stat.arr }}</td>
                                    <td>{{ stat.nb_pleines }}</td>
                                    <td>{{ stat.nb_vides if stat.nb_vides is defined else 'N/A' }}</td>
                                    <td>
                                        {% set total = (stat.nb_pleines + (stat.nb_vides if stat.nb_vides is defined else 0)) %}
                                        {% if total > 0 %}{{ ((stat.nb_pleines / total) * 100) | round(1) }}%{% else %}N/A{% endif %}
                                    </td>
                                    <td>
                                        {% if total > 0 %}{{ ((stat.nb_vides / total) * 100) | round(1) }}%{% else %}N/A{% endif %}
                                    </td>
                                    <td>
                                        {% if stat.nb_pleines < 7 %}
                                            <span class="badge bg-success">{{ _('Optimal') }}</span>
                                        {% elif stat.nb_pleines <= 10 %}
                                            <span class="badge bg-warning">{{ _('Attention') }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ _('Zone à risque') }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CSS + JS externes -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
    <style>
    /* Coins arrondis uniquement sur les coins extérieurs du tableau */
    .custom-table-center {
        margin-left: auto;
        margin-right: auto;
        border-collapse: separate;
        border-spacing: 0;
    }
    .custom-table-center thead th:first-child {
        border-top-left-radius: 16px;
    }
    .custom-table-center thead th:last-child {
        border-top-right-radius: 16px;
    }
    .custom-table-center tbody tr:last-child td:first-child {
        border-bottom-left-radius: 16px;
    }
    .custom-table-center tbody tr:last-child td:last-child {
        border-bottom-right-radius: 16px;
    }

    /* Pagination DataTables : 7 carrés verts, chiffres blancs, sans coins arrondis */
    .dataTables_wrapper .dataTables_paginate {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 1.2rem;
        gap: 0.3rem;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        background: var(--light-green, #7fb069) !important;
        color: var(--cream, #fefefe) !important;
        border: none !important;
        border-radius: 0 !important;
        width: 2.3em;
        height: 2.3em;
        min-width: 2.3em;
        min-height: 2.3em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1em;
        font-family: 'Inter', Arial, sans-serif;
        transition: background 0.18s, color 0.18s;
        box-shadow: none !important;
        cursor: pointer;
        outline: none;
        margin: 0 0.08em;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:focus {
        background: var(--light-green, #7fb069) !important;
        color: var(--cream, #fefefe) !important;
        border: none !important;
        box-shadow: 0 0 0 2px var(--primary-green, #4a7c59);
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.current) {
        background: var(--sage-green, #8fbc8f) !important;
        color: var(--cream, #fefefe) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
        opacity: 0.5;
        pointer-events: none;
        background: var(--soft-gray, #e9ecef) !important;
        color: var(--text-secondary, #636e72) !important;
        border: none !important;
    }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

    <!-- Variables injectées par Jinja -->
    <script>
        var xValues = ["{{ _('pleines') }}", "{{ _('vides') }}"];
        var yValues = [{{ full_annotations|tojson }}, {{ empty_annotations|tojson }}];
        var barColors = ["#8fbc8f", "#fefefe"];
        var nbFichiersLabel = "{{ _('Nombre de fichiers') }}";
        var tailleOctetsLabel = "{{ _('Taille (octets)') }}";
        var aucuneDonnee = "{{ _('Aucune donnée disponible') }}";
        var total_annot = {{ total_annotations | tojson }};
        var total_possible = 720;
        {% if size_files and occ_size_files %}
        var sizeFiles = {{ size_files|tojson }};
        var occSizeFiles = {{ occ_size_files|tojson }};
        {% else %}
        var sizeFiles = [];
        var occSizeFiles = [];
        {% endif %}
    </script>

    <!-- JS principal -->
    <script>
    $(document).ready(function() {
        $('#stats-table').DataTable({
            paging: false,
            searching: false,
            info: false,
            ordering: false,
            responsive: true,
            language: {
                emptyTable: aucuneDonnee
            }
        });
        // Pagination sur le tableau des arrondissements (7 par page)
        $('#arr-table').DataTable({
            paging: true,
            pageLength: 7,
            lengthChange: false,
            searching: false,
            info: false,
            ordering: false,
            responsive: true,
            language: {
                emptyTable: aucuneDonnee,
                paginate: {
                    previous: "<",
                    next: ">"
                }
            }
        });
    });

    // Graphique doughnut : progression des annotations
    new Chart(document.getElementById('progressChart'), {
        type: 'doughnut',
        data: {
            labels: ["{{ _('Annotations actuelles') }}", "{{ _('Annotations possibles') }}"],
            datasets: [{
                data: [total_annot, total_possible - total_annot],
                backgroundColor: ['#8fbc8f', '#e9ecef'], // sage-green, soft-gray
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%',
            responsive: true,
            plugins: {
                legend: { display: true },
                title: {
                    display: true,
                    text: "{{ _('Nombre d\'images uploadées') }}"
                }
            }
        }
    });

    // Graphique pie : répartition pleines vs vides
    new Chart(document.getElementById("repartition"), {
        type: "pie",
        data: {
            labels: xValues,
            datasets: [{
                backgroundColor: ["#8fbc8f", "#fefefe"], // sage-green, cream
                data: yValues
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                title: {
                    display: true,
                    text: "{{ _('Répartition des annotations (pleines vs vides)') }}"
                }
            }
        }
    });

    // Graphique barres : distribution des tailles de fichiers
    if(sizeFiles.length && occSizeFiles.length) {
        new Chart(document.getElementById("distribution"), {
            type: "bar",
            data: {
                labels: sizeFiles,
                datasets: [{
                    label: nbFichiersLabel,
                    backgroundColor: "#4CAF50",
                    data: occSizeFiles
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: "{{ _('Distribution des tailles de fichiers') }}"
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { title: { display: true, text: tailleOctetsLabel } },
                    y: { beginAtZero: true, ticks: { precision: 0 } }
                }
            }
        });
    }
    </script>
{% endblock %}
