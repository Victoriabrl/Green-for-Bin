{% extends "base.html" %}

{% block title %}Visualisations{% endblock %}

{% block content %}
    <h1>{{ _('Vous pouvez visualiser les données de vos poubelles ici.') }}</h1>

    <h2>{{ _('Statistiques') }}</h2>
    <div class="table-responsive">
        <table id="stats-table" class="table table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th>{{ _('Type') }}</th>
                    <th>{{ _('Valeur') }}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ _('Nombre total d\'annotations') }}</td>
                    <td>{{ total_annotations }}</td>
                </tr>
                <tr>
                    <td>{{ _('Nombre d\'annotations poubelles pleines') }}</td>
                    <td>{{ full_annotations }}</td>
                </tr>
                <tr>
                    <td>{{ _('Nombre d\'annotations poubelles vides') }}</td>
                    <td>{{ empty_annotations }}</td>
                </tr>
                <tr>
                    <td>{{ _('Nombre d\'annotations non labelisées') }}</td>
                    <td>{{ non_labelled_annotations }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <h2 class="mt-4">{{ _('Visualisations') }}</h2>
    <div class="row mb-4">
        <div class="col-md-6">
            <canvas id="progressChart" style="max-width: 100%; height: 260px;"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="repartition" style="max-width: 100%; height: 260px;"></canvas>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <h5>{{ _('Distribution des tailles de fichiers :') }}</h5>
            <canvas id="distribution" style="max-width: 100%; height: 260px;"></canvas>
        </div>
    </div>

    <img src="{{ image_base64 }}" alt="Graphique" class="img-fluid mb-2">
    <img src="{{ img_base64_distribution }}" alt="Graphique de distribution des tailles de fichiers" class="img-fluid mb-2">
    <img src="{{ img_base64_nombre }}" alt="Graphique de nombre d'images" class="img-fluid mb-4">

    <!-- CSS + JS externes -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

    <!-- Variables injectées par Jinja -->
    <script>
        var xValues = ["{{ _('pleines') }}", "{{ _('vides') }}"];
        var yValues = [{{ full_annotations|tojson }}, {{ empty_annotations|tojson }}];
        var barColors = ["#388e3c", "#a5d6a7"];
        var nbFichiersLabel = "{{ _('Nombre de fichiers') }}";
        var tailleOctetsLabel = "{{ _('Taille (octets)') }}";
        var aucuneDonnee = "{{ _('Aucune donnée disponible') }}";
        var total_annot = {{ total_annotations | tojson }};
        var total_possible = 720;
        {% if size_files and occ_size_files %}
        var sizeFiles = {{ size_files|tojson }};
        var occSizeFiles = {{ occ_size_files|tojson }};
        {% else %}
        var sizeFiles = [];
        var occSizeFiles = [];
        {% endif %}
    </script>

    <!-- JS principal -->
    <script>
    $(document).ready(function() {
        $('#stats-table').DataTable({
            paging: false,
            searching: false,
            info: false,
            ordering: false,
            responsive: true,
            language: {
                emptyTable: aucuneDonnee
            }
        });
    });

    // Graphique doughnut : progression des annotations
    new Chart(document.getElementById('progressChart'), {
        type: 'doughnut',
        data: {
            labels: ["{{ _('Annotations actuelles') }}", "{{ _('Annotations possibles') }}"],
            datasets: [{
                data: [total_annot, total_possible - total_annot],
                backgroundColor: ['#4CAF50', '#e0e0e0'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%',
            responsive: true,
            plugins: {
                legend: { display: true },
                title: {
                    display: true,
                    text: "{{ _('Nombre d\'images uploadées') }}"
                }
            }
        }
    });

    // Graphique pie : répartition pleines vs vides
    new Chart(document.getElementById("repartition"), {
        type: "pie",
        data: {
            labels: xValues,
            datasets: [{
                backgroundColor: barColors,
                data: yValues
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                title: {
                    display: true,
                    text: "{{ _('Répartition des annotations (pleines vs vides)') }}"
                }
            }
        }
    });

    // Graphique barres : distribution des tailles de fichiers
    if(sizeFiles.length && occSizeFiles.length) {
        new Chart(document.getElementById("distribution"), {
            type: "bar",
            data: {
                labels: sizeFiles,
                datasets: [{
                    label: nbFichiersLabel,
                    backgroundColor: "#4CAF50",
                    data: occSizeFiles
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: "{{ _('Distribution des tailles de fichiers') }}"
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { title: { display: true, text: tailleOctetsLabel } },
                    y: { beginAtZero: true, ticks: { precision: 0 } }
                }
            }
        });
    }
    </script>
{% endblock %}
